---
  - name: Get storage info
    hosts: all
    vars_files:
      - ../vars/windows.yml
    #connection: local
    #gather_facts: true
    tasks:
      - name: Show EC2 volume info
        ansible.builtin.debug:
          msg: "{{ inventory_hostname_short }}"
        delegate_to: localhost
        vars:
          ansible_connection: local
      - name: Get EC2 instance info
        amazon.aws.ec2_instance_info:
          filters:
            "tag:Name": "{{ inventory_hostname_short }}"
            instance-state-name: ["running"]
          region: "{{ hostvars[inventory_hostname].placement.region }}"
        register: ec2_instance
        delegate_to: localhost
        vars:
          ansible_connection: local
      - name: Show EC2 instance info
        ansible.builtin.debug:
          msg: "{{ ec2_instance.instances[0].instance_id }}"
        delegate_to: localhost
        vars:
          ansible_connection: local
      - name: Make sure one instance was returned
        ansible.builtin.fail:
          msg: "No instance found for {{ inventory_hostname_short }}"
        when: ec2_instance.instances | length == 0 or ec2_instance.instances | length > 1
        delegate_to: localhost
        vars:
          ansible_connection: local
      - name: Gather EC2 volume info
        amazon.aws.ec2_vol_info:
          filters:
            attachment.instance_id: "{{ ec2_instance.instances[0].instance_id }}"
          region: "{{ hostvars[inventory_hostname].placement.region }}"
        register: ec2_vol_info
        delegate_to: localhost
        vars:
          ansible_connection: local
      - name: Show EC2 volume info
        ansible.builtin.debug:
          msg: "{{ ec2_vol_info }}"
        delegate_to: localhost
        vars:
          ansible_connection: local
      - name: Get disk facts
        community.windows.win_disk_facts:
        register: windows_disks
      # - name: Show disk information
      #   ansible.builtin.debug:
      #     msg: "{{ item }}"
      #   loop: "{{ windows_disks.ansible_facts.ansible_disks }}"
      #   delegate_to: localhost
      #   vars:
      #     ansible_connection: local
      - name: Get volume name to id mapping
        ansible.builtin.set_fact:
          vol_name_to_path: "{{ vol_name_to_path | default({}) | combine({vol_name[0]: item.path}) }}"
        vars:
          vol_name: "{{ item.serial_number | split('_') }}"
          ansible_connection: local
        delegate_to: localhost
        when: item.partition_count == 0
        loop: "{{ windows_disks.ansible_facts.ansible_disks }}"
      - name: Show disk information
        ansible.builtin.debug:
          msg: "{{ vol_name_to_path }}"
        delegate_to: localhost
        vars:
          ansible_connection: local